<!--  Emotion regulation experiment online using Javascript and jsPsych Library
            - Author: Juliana Sporrer (juliana.sporrer.18@ucl.ac.uk)
            - Creation date: March 2020

            Data Output:
                  - rt
                  - stimulus
                  - responses (only for subdetails)
                  - key_press ([79,78] for oui [o] and non [n])
                  - test_part (the name we give to the trial, e.g. "quest_pract")
                  - blockNb
                  - trialNb
                  - condiEmoBlock (1 = DC // 2 == BC)
                  - condiEmoTrial (1 = DC_male, 2 = DC_female, 3 = CC_male, 4 = CC_female, 5 = BC_male , 6 = BC_female)
                  - condiRwd (1= Small rwd // 2 = Large rwd)
                  - posCritDist (position of the distractor, between 4 and 8 included)
                  - posTarget (position of the target, either 1 or 3 images after the distractor)
                  - trial_type (indicate the nature of the plugin)
                  - trial_index
                  - time_elapsed
                  - internal_node_id
                  - subject_id

-->
<!DOCTYPE html>
<html>
    <head>
        <title>   My experiment EMO </title>
        <script  src = "jspsych-master/jspsych.js"></script> <!-- import the library, should be downloaded and put into your experiment folder -->
        <link    href= "jspsych-master/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <script  src = "jspsych-master/plugins_JS/fullscreen-emo.js"></script> <!-- plugin that I modified -->
        <script  src = "jspsych-master/plugins_JS/html-keyboard-response-emo.js"></script>
        <script  src = "jspsych-master/plugins_JS/survey-text-emo.js"></script>
        <script  src = "jspsych-master/plugins_JS/image-keyboard-response-emo.js"></script>
        <script  src = "getBrowserInfo.js"></script> <!-- add the external functions-->
        <script  src = "createCondiMatrix.js"></script>
        <script  src = "rsvp.js"></script>
        <script  src = "instr.js"></script>
        <style   id ="cursornone"> html { cursor: none; };  </style>
    </head>
    <body>
          <div id='jspsych-target' style='width:auto; height:auto; position:relative;'></div>
          <canvas class = "canvas" id="myCanvas"></canvas>
   </body>
   <script>

// --------------------------------- PARAMETERS --------------------------------//

    var nbBlocksPrac      = 2; // 2
    var nbTrialsPrac      = 6; // 6
    var nbBlocksExp       = 2; // 12
    var nbTrialsExp       = 6; // 18

    var setSize           = 15;
    var imageDuration     = 50; // in ms
    var fixation_time     = 500;

    var nbInstr           = 12; // how many Instr Slides
    var debug             = true; // if true, skips fullscreen and info

// --------------------------------- INITIALISATION  ---------------------------//

    // Checks if the browser is Chrome or Firefox (best compatibility)
    var browserInfo = getBrowserInfo(); // Call the function that I specified in the head

    if(browserInfo.browser !== 'Chrome' && browserInfo.browser !== 'Firefox'){
            var wrong_browser = {
                    type: 'html-keyboard-response',
                    stimulus: '<p> This experiment only has support for Google Chrome or Mozilla Firefox. </p>'
                             +'<p> Please re-open the experiment in one of these browsers. </p>',
            };
            jsPsych.init({
                    timeline: [wrong_browser],
            });
    }

    else { // If browser is ok, lead on to the experimentIF BROWSER IS OK, LEAD ON TO THE EXPERIMENT

          // Removes the cursor
          let cursornone = document.getElementById("cursornone").innerHTML;

          function randi(min, max) { // min and max included (acts like randi of Matlab)
                return Math.floor(Math.random() * (max - min + 1) + min);
          }

          // Create "Variable/function" that makes sure you remain in FullScreen
          var firstFullscreen =	{
                type: 'fullscreen', // Call the function "fullscreen" of the pluggin "fullscreen_emo"
                message:'<p> To take part in the experiment, your browser must be in fullscreen mode. </p> <p>Exiting fullscreen mode will pause the experiment. </p> <p> Please click the button below to enable fullscreen mode and continue.</p>',
                button_label: 'Put in Fullscreen',
                delay_after: 300,
                check_fullscreen: true,
                data: {
                      test_part: 'firstFullscreen',
                      blockNb: null,
                      trialNb: null,
                      condiEmoBlock: null,
                      condiEmoTrial: null,
                      condiRwd: null,
                      posCritDist: null,
                      posTarget: null,
                },
          };

          var fullscreenExp = {
                type: 'fullscreen',
                message: '<p>You need to be in fullscreen mode to continue the experiment! <br></br> Please click the button below to enter fullscreen mode.<br></br><p>',
                fullscreen_mode: false,
                data: {
                      test_part: 'fullscreenExp',
                      blockNb: null,
                      trialNb: null,
                      condiEmoBlock: null,
                      condiEmoTrial: null,
                      condiRwd: null,
                      posCritDist: null,
                      posTarget: null,
                },
          };

          // Ask the participants to enter details
          var subdetails = {
                type: 'survey-text',
                preamble: ['<p style = "text-align: center; font-size: 28px">Please enter the following:</p>'],
                questions: [{prompt: "Worker ID?", rows: 3, columns: 40}],
                data: {
                      test_part: 'subdetails',
                      blockNb: null,
                      trialNb: null,
                      condiEmoBlock: null,
                      condiEmoTrial: null,
                      condiRwd: null,
                      posCritDist: null,
                      posTarget: null,
                },
                on_start: function(){
                      var res = cursornone.replace("none", "default");
                      document.getElementById("cursornone").innerHTML = res;
                },
                on_finish: function(){
                      var res = cursornone.replace("default", "none");
                      document.getElementById("cursornone").innerHTML = res;
                },
          };

          var subdetails2 = {
                type: 'survey-text',
                preamble: ['<p style = "text-align: center; font-size: 28px">Please enter the following:</p>'],
                questions: [{prompt: "Gender (F/M)?", rows: 3, columns: 40}, {prompt: "Age?", rows: 3, columns: 40}],
                data: {
                      test_part: 'subdetails2',
                      blockNb: null,
                      trialNb: null,
                      condiEmoBlock: null,
                      condiEmoTrial: null,
                      condiRwd: null,
                      posCritDist: null,
                      posTarget: null,
                },
                on_start: function(){
                      var res = cursornone.replace("none", "default");
                      document.getElementById("cursornone").innerHTML = res;
                },
                on_finish: function(){
                      var res = cursornone.replace("default", "none");
                      document.getElementById("cursornone").innerHTML = res;
                },
          };

// --------------------------------- PRE-LOAD ANY MEDIA  -----------------------//
            // Example
            var instrImg = [];
            for(var t=1;t <= nbInstr;t++){
                  instrImg[t-1] = 'instructions/instructionsDiapo/Slide'+t+'.jpg'; // Pre-load all the jpg files in this folder
            };

            var imgWFF = []; var scrambleWFF = [];
            for(var t=1;t < 36+1;t++){
                  imgWFF[t-1] = 'imgJS/WFF_'+t+'.jpg'; // Pre-load all the jpg files in this folder
                  scrambleWFF[t-1] = 'imgJS/WFF_scramble_'+t+'.jpg'; // Pre-load all the jpg files in this folder
            };

            var imgWFN = []; var scrambleWFN = [];
            for(var t=1;t < 86+1;t++){
                  imgWFN[t-1] = 'imgJS/WFN_'+t+'.jpg'; // Pre-load all the jpg files in this folder
                  scrambleWFN[t-1] = 'imgJS/WFN_scramble_'+t+'.jpg'; // Pre-load all the jpg files in this folder
            };

            var imgWMF = []; var scrambleWMF = [];
            for(var t=1;t < 29+1;t++){
                  imgWMF[t-1] = 'imgJS/WMF_'+t+'.jpg'; // Pre-load all the jpg files in this folder
                  scrambleWMF[t-1] = 'imgJS/WMF_scramble_'+t+'.jpg'; // Pre-load all the jpg files in this folder
            };

            var imgWMN = []; var scrambleWMN = [];
            for(var t=1;t < 91+1;t++){
                  imgWMN[t-1] = 'imgJS/WMN_'+t+'.jpg'; // Pre-load all the jpg files in this folder
                  scrambleWMN[t-1] = 'imgJS/WMN_scramble_'+t+'.jpg'; // Pre-load all the jpg files in this folder
            };

            imgCondi  = ['imgJS/instDC.jpg', 'imgJS/instBC.jpg'];
            imgRwd    = ['imgJS/cent.jpg', 'imgJS/euro.jpg'];

            function updateLoadedCount(nLoaded){
              var percentcomplete = nLoaded / (instrImg.length + imgWFF.length + imgWFN.length + imgWMF.length + imgWMN.length + imgCondi.length + imgRwd.length)  * 100;
              console.log('Loaded '+percentcomplete+'% of images');
            }

// --------------------------------- BEGINING EXPERIMENT  ----------------------//

            var subject_id    = Math.floor(Math.random()*9000000) + 1000000; // there is a new extention, i.e. var subject_id = jsPsych.randomization.randomID(15)

            var exp_timeline = [];

            var firstInstr    = instr([0,1,7,8,2,9]);
            var endPract      = instr([10]);
            var endExp        = instr([11]);

            if(debug == false){
                  jsPsych.pluginAPI.preloadImages([instrImg, imgWFF, imgWFN, imgWMF, imgWMN, imgCondi, imgRwd],
                  function(){ startExperiment();},
                  function(nLoaded) {updateLoadedCount(nLoaded);});
                  exp_timeline.push(firstFullscreen);
                  exp_timeline.push(subdetails);
                  exp_timeline.push(subdetails2);

                  for(var i = 0; i < firstInstr.length; i++){
                         exp_timeline.push(firstInstr[i]);
                  };
            }
            var practice      = rsvp(nbBlocksPrac, nbTrialsPrac, 1);
            for(var i = 0; i < practice.length; i++){
                  exp_timeline.push(practice[i]);
            };

            for(var i = 0; i < endPract.length; i++){
                   exp_timeline.push(endPract[i]);
            };

            var task          = rsvp(nbBlocksExp, nbTrialsExp, 0);
            for(var i = 0; i < task.length; i++){
                  exp_timeline.push(task[i]);
            };

            for(var i = 0; i < endPract.length; i++){
                   exp_timeline.push(endExp[i]);
            };

            // Execute the experiment
            //function startExperiment(){
              jsPsych.init({
                //preload_images: [instrImg, imgWFF,imgWFN, imgWMF,imgWMN],
                timeline: exp_timeline,
                show_progress_bar: true,

                on_trial_finish: function() {
                  jsPsych.data.addProperties({
                    subject_id: subject_id
                  });
                  var data = JSON.parse(jsPsych.data.getLastTrialData().json());
                  //save_data_pt(data);
                },
                on_finish: function() {
                  //jsPsych.data.localSave('emo' + subject_id + 'local.csv', 'csv');
                  jsPsych.data.displayData(); // Disable once online, use to look at data while coding
                  //document.write('<p><br></br><br></br><center>Thank you for participating! <br></br> Your data code is <strong>'+subject_id+'</strong>.<br></center><p>')
                },
              });
//            }

    } // End of the experiment (end of checking browser)
</script>
</html>
